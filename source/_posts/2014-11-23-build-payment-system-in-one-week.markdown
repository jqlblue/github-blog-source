---
layout: post
title: "一周打造支付系统"
description:
keywords:
date: 2014-11-23 14:34
comments: true
categories: [php]
tags: [php]
toc: true
---
获取食物的最佳方式就是处于食物链的顶端，以捕食该链条之下的所有动植物。不言而喻，搭建处于资金流顶端的支付系统，伴随资金的转移过程，也是积累财富的绝佳手段。
<!-- more -->
# 一般网购流程 #
{% img /images/payment/shopping_flow.png shopping flow %}

一般的网购流程如上图：

* 商品筛选
* 将选中的商品添加到购物车（顾名思义，推着车去购物。如果只卖一个商品的话，可以省略这步）
* 确认要购买物品，去结算
* 下订单，即提交要结算物品的清单
* 网上支付该订单


# 支付流程 #
{% img /images/payment/flow.jpg payment flow %}

一个典型的支付流程如上图。

用户下单时，订单系统需要和产品库交互，生成支付连接。支付系统对请求地址进行验签之后，调用第三方平台的支付接口进行支付，然后更新订单状态。在订单成功支付之后，更新产品库存信息。

属于支付系统的功能有：

* 请求参数验签
* 第三方支付接口对接
* 订单系统对接


> 只要完成与第三方支付接口的对接，即可解决搭建支付系统中最难啃的一块硬骨头。

# 第三方支付平台 #
目前比较流行的第三方支付平台主要有：

* 支付宝
* 财付通
* 快钱
* 网银在线
* 微信支付

对于网银支付，可以调用银联的接口，或者直接对接银行（可以降低手续费，支持大额等个性化支付方法。但是实现成本较高）。

虽然支付宝的手续费不是最实惠的，但是支付宝本身对接了个大银行的网银支付，而我们的目标是一周打造支付系统，当然选择最省事的。

对接支付宝支付接口的流程如下：

{% img /images/payment/zhifubao.jpg 支付宝对接 %}

完成`技术集成`之前的工作，理论上需要8-10个工作日，所以需要提前申请。

最好找商务部的同事出马，不要怕麻烦boss。有问题，及时向组织反馈。


# 支付宝接口 #

与支付宝接口的交互流程如下

{% img /images/payment/zhifubao_flow.jpg 支付宝接口交互流程  %}

支付宝接口说明

要调用的方法
# ssl证书 #
俗话说，没有买卖就没有杀戮。凡是涉及利益的地方，就不会很安全。使用采用http进行数据通讯，难免发生如下问题：
{% img /images/payment/http_flow.jpg 中间人攻击 %}

但是换成https，会有如下好处：

{% img /images/payment/https_2.jpg http ssl %}

{% img /images/payment/https_3.jpg https flow %}

申请ssl证书，推荐数字公司使用的[WoSign超真 SSL](http://www.wosign.com/price.htm)。

{% img /images/payment/ssl.jpg ssl %}

# 请求验签 #
请求参数签名，需要使用可逆加密算法。其中又分为：

* 对称加解密算法
* 非对称加解密算法


对称加解密算法，在加密和解密时都使用一个密钥，加解密性能较好。但安全性较低（密钥只要被拿到，就gameover）。

非对称加解密算法，一般使用私钥加密，公钥解密。其安全性较好（只要保存好私钥就行），但是性能较差。

所以可以使用对称加解密算法加密请求参数。但加解密时，不使用同一个密钥。相关密钥，通过非对称加解密算法加密后，在请求参数中传递。

解密流程如下：
    1. 在请求参数中获取使用非对称加解密算法加密的密钥ekey
    2. 使用非对称加解密算法解密密钥ekey为dkey
    3. 使用对称加解密算法和dkey，解密请求参数

# 订单 #
我们用一周打造的支付系统，不能是一个远在云端的架构，而要是一个可运行的系统。那么，订单自然也少不了。

订单的生成规则。后台等等
# 联调部署 ＃

将所有系统整合起来

# The Hole #

一些坑

1 分钱
2 平行权限
3 xss
4 两个订单号。内部流通的订单号，支付订单号

5 sqlmap
6 xssscapy
